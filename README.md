# FinalOR GT VHDL files
# Supported boards

| Board | FPGA | Depfile name | 
| ---      | ---      | ---      |
| Serenity | VU9P-2-e-flga2577[^1] | `top_serenity_vu9p-so2.d3` |
| Serenity | VU13P-2-e-flga2577 | `top_serenity_vu13p-so2.d3` |

[^1]:Works only with half of the input links  

# Requirements

* Vivado 2020.1 or later
* ipbb 2021j or later
* uHAL[^2]
* Access to the TCDS2 Gitlab repository. (Can be requested at https://cmstcds2.docs.cern.ch/.)
* Access to the EMP repository.

[^2]: https://ipbus.web.cern.ch/doc/user/html/software/installation.html

# Setup instructions

### Get all the required packages
```bash
# If you don't have ipbb installed yet
curl -L https://github.com/ipbus/ipbb/archive/dev/2021j.tar.gz | tar xvz
source ipbb-dev-2021j/env.sh

ipbb init gt-algorithm-work
cd gt-algorithm-work
ipbb add git https://:@gitlab.cern.ch:8443/p2-xware/firmware/emp-fwk.git -b v0.6.8
ipbb add git https://github.com/ipbus/ipbus-firmware -b v1.9
ipbb add git https://:@gitlab.cern.ch:8443/cms-tcds/cms-tcds2-firmware.git -b v0_1_1
ipbb add git https://gitlab.cern.ch/HPTD/tclink.git -r fda0bcf
ipbb add git https://gitlab.cern.ch/ttc/legacy_ttc.git -b v2.1
ipbb add git https://:@gitlab.cern.ch:8443/cms-cactus/phase2/firmware/gt-final-or.git
```

# Build instructions
### Create firmware project
```bash
ipbb proj create vivado gt-final-or gt-final-or:finor-hdl [depfile name]  # See above for possible choices.
cd proj/gt-final-or

# Make uhal tools available
export PATH=/opt/cactus/bin/uhal/tools:$PATH
export LD_LIBRARY_PATH=/opt/cactus/lib:$LD_LIBRARY_PATH

ipbb ipbus gendecoders -f
ipbb vivado generate-project
```

And build it with:

```bash
ipbb vivado synth -j4 impl -j4
ipbb vivado bitfile package
```

# Simulation instructions
Get required packages as in the previous section.

### Create the simulation project
```bash
ipbb proj create vivado finor_sim gt-final-or:simulation [depfile name]  # See above for possible choices.
cd proj/finor_sim
ipbb vivado generate-project
```

### Run the simulation within Vivado GUI
The input pattern file is generated by a custom python script, it can be found ```scripts/PatternProducer.py```.  
Run the script 
```bash
cd scripts
python PatternProducer.py -i 1152 -s Serenity3
```

The relative ```.txt``` file is saved in the folder ```scripts/Pattern_files/Finor_input_pattern.txt```.  
To enter in the Vivado GUI run the command

```bash
vivado finor_sim/finor_sim.xpr
```

